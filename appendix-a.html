<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>附录A：测度论与随机过程速成 - Diffusion Models Tutorial</title>
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    <script defer src="common.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <a href="index.html">← 返回目录</a>
            <span>附录A</span>
            <a href="appendix-b.html">附录B →</a>
        </div>
        
        <h1>附录A：测度论与随机过程速成</h1>
        
        <div class="chapter-intro">
            本附录为理解第5章（连续时间扩散模型）提供必要的数学基础。我们将快速回顾测度论的核心概念，介绍布朗运动和随机微分方程的基本知识。这不是完整的数学课程，而是为理解扩散模型所需的最小知识集。
        </div>
        
        <h2>A.1 测度论基础</h2>
        
        <h3>A.1.1 为什么需要测度论？</h3>
        
        <p>让我们从一个简单但深刻的问题开始：<strong>在区间[0,1]上随机选一个点，这个点恰好是有理数的概率是多少？</strong></p>
        
        <p>你的直觉可能会说："有理数有无穷多个，所以概率应该很大。"但实际上，这个概率是0！这个反直觉的结果揭示了我们需要一个比传统概率论更精细的数学框架。</p>
        
        <div class="note">
            <strong>直观理解：</strong>想象你在数轴上随机投掷飞镖。虽然有理数密密麻麻地分布在数轴上（任意两个不同的实数之间都有无穷多个有理数），但它们太"稀疏"了——就像在无限的海洋中撒了无限多粒沙子，但每粒沙子都是孤立的点，没有"体积"。
        </div>
        
        <p>测度论正是为了严格处理这类"无穷"而诞生的。它不仅能处理"长度"、"面积"、"体积"，还能处理更抽象的"大小"概念。在随机过程中，我们需要测度论来：</p>
        <ul>
            <li>定义什么是"随机事件"（可测集）</li>
            <li>给事件赋予"概率"（测度）</li>
            <li>处理连续时间上的无穷多个随机变量</li>
            <li>严格定义条件期望和鞅</li>
        </ul>
        
        <h3>A.1.2 σ-代数：可测量的事件</h3>
        
        <p>在概率论中，不是所有的子集都能被赋予概率。我们需要一个"合理"的集合族来定义哪些事件是可测的。</p>
        
        <div class="definition">
            <div class="definition-title">定义 A.1（σ-代数）</div>
            设 $\Omega$ 是一个非空集合（样本空间）。$\Omega$ 的子集族 $\mathcal{F}$ 称为 σ-代数，如果：
            <ol>
                <li>$\Omega \in \mathcal{F}$（全集可测）</li>
                <li>若 $A \in \mathcal{F}$，则 $A^c \in \mathcal{F}$（对补运算封闭）</li>
                <li>若 $A_1, A_2, \ldots \in \mathcal{F}$，则 $\bigcup_{i=1}^{\infty} A_i \in \mathcal{F}$（对可数并封闭）</li>
            </ol>
        </div>
        
        <p>σ-代数的三个条件可以理解为：</p>
        <ul>
            <li><strong>条件1</strong>：必然事件是可测的</li>
            <li><strong>条件2</strong>：如果事件A可测，那么"A不发生"也应该可测</li>
            <li><strong>条件3</strong>：如果每个事件都可测，那么"至少有一个发生"也应该可测</li>
        </ul>
        
        <div class="visualization">
            <p><strong>例子：掷硬币的σ-代数</strong></p>
            <p>考虑掷一次硬币，$\Omega = \{H, T\}$（H=正面，T=反面）</p>
            <p>最小的σ-代数（平凡σ-代数）：$\mathcal{F}_1 = \{\emptyset, \{H, T\}\}$</p>
            <p>最大的σ-代数（幂集）：$\mathcal{F}_2 = \{\emptyset, \{H\}, \{T\}, \{H, T\}\}$</p>
            <p>注意：$\{\emptyset, \{H\}\}$ 不是σ-代数，因为缺少 $\{H\}^c = \{T\}$</p>
        </div>
        
        <h3>A.1.3 测度：给集合赋予"大小"</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.2（测度）</div>
            测度 $\mu: \mathcal{F} \rightarrow [0, \infty]$ 是满足以下条件的函数：
            <ol>
                <li>$\mu(\emptyset) = 0$（空集的测度为0）</li>
                <li>可数可加性：对于两两不交的 $A_1, A_2, \ldots \in \mathcal{F}$，
                    $$\mu\left(\bigcup_{i=1}^{\infty} A_i\right) = \sum_{i=1}^{\infty} \mu(A_i)$$</li>
            </ol>
        </div>
        
        <p>测度推广了我们熟悉的概念：</p>
        <ul>
            <li><strong>长度</strong>：实数轴上的Lebesgue测度，$\mu([a,b]) = b - a$</li>
            <li><strong>面积</strong>：平面上的二维Lebesgue测度</li>
            <li><strong>概率</strong>：当 $\mu(\Omega) = 1$ 时，$\mu$ 称为概率测度 $\mathbb{P}$</li>
            <li><strong>计数</strong>：计数测度，$\mu(A) = |A|$（集合中元素的个数）</li>
        </ul>
        
        <div class="note">
            <strong>关键洞察：</strong>测度的可数可加性是其最重要的性质。它说明了为什么有理数在实数中的测度为0：
            <ul>
                <li>每个单点集 $\{r\}$ 的Lebesgue测度为0</li>
                <li>有理数集 $\mathbb{Q} \cap [0,1]$ 是可数个单点的并</li>
                <li>由可数可加性：$\mu(\mathbb{Q} \cap [0,1]) = \sum_{r \in \mathbb{Q} \cap [0,1]} \mu(\{r\}) = \sum 0 = 0$</li>
            </ul>
        </div>
        
        <h3>A.1.4 可测函数与随机变量</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.3（随机变量）</div>
            设 $(\Omega, \mathcal{F}, \mathbb{P})$ 是概率空间。函数 $X: \Omega \rightarrow \mathbb{R}$ 称为随机变量，如果对任意 Borel 集 $B \subseteq \mathbb{R}$，有
            $$X^{-1}(B) = \{\omega \in \Omega : X(\omega) \in B\} \in \mathcal{F}$$
        </div>
        
        <p>这个定义看起来抽象，但其核心思想很简单：<strong>随机变量必须与我们的σ-代数兼容</strong>。</p>
        
        <div class="visualization">
            <p><strong>例子：掷骰子的随机变量</strong></p>
            <p>$\Omega = \{1, 2, 3, 4, 5, 6\}$，$\mathcal{F} = 2^{\Omega}$（幂集）</p>
            <p>定义随机变量 $X(\omega) = \omega$（点数本身）</p>
            <p>事件"点数大于4" = $\{\omega: X(\omega) > 4\} = \{5, 6\} \in \mathcal{F}$ ✓</p>
            <p>定义另一个随机变量 $Y(\omega) = \begin{cases} 1 & \text{if } \omega \text{ 是偶数} \\ 0 & \text{if } \omega \text{ 是奇数} \end{cases}$</p>
            <p>$Y$ 将骰子结果映射到"奇偶性"，仍然是可测的</p>
        </div>
        
        <p>在连续情况下，Borel σ-代数包含了所有"常见"的集合（开区间、闭区间、单点等），所以实践中几乎所有函数都是可测的。</p>
        
        <h3>A.1.5 条件期望与滤波</h3>
        
        <p>在随机过程中，我们经常需要基于"部分信息"进行预测。这就是条件期望的作用。</p>
        
        <div class="definition">
            <div class="definition-title">定义 A.4（滤波）</div>
            滤波（filtration）$\{\mathcal{F}_t\}_{t \geq 0}$ 是一族递增的σ-代数：
            $$\mathcal{F}_s \subseteq \mathcal{F}_t \subseteq \mathcal{F}, \quad \forall s \leq t$$
        </div>
        
        <p>滤波代表"信息的累积"：$\mathcal{F}_t$ 包含了到时刻 $t$ 为止的所有可观测信息。</p>
        
        <div class="note">
            <strong>直观理解：</strong>想象你在观看一场足球比赛：
            <ul>
                <li>$\mathcal{F}_0$：比赛开始前的信息（球队阵容等）</li>
                <li>$\mathcal{F}_{45}$：上半场结束时的信息（比分、黄牌等）</li>
                <li>$\mathcal{F}_{90}$：全场比赛的完整信息</li>
            </ul>
            随着时间推进，你知道的信息越来越多，但不会"忘记"之前的信息。
        </div>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.1：构造σ-代数</div>
            <p>设 $\Omega = \{1, 2, 3, 4\}$，事件 $A = \{1, 2\}$。</p>
            <ol>
                <li>构造包含 $A$ 的最小σ-代数 $\sigma(A)$</li>
                <li>如果再加入事件 $B = \{2, 3\}$，最小σ-代数 $\sigma(A, B)$ 是什么？</li>
            </ol>
            <button class="answer-toggle" onclick="toggleAnswer('answerA1')">显示答案</button>
            <div id="answerA1" class="answer">
                <p><strong>解答：</strong></p>
                <p>1. $\sigma(A) = \{\emptyset, \{1,2\}, \{3,4\}, \{1,2,3,4\}\}$</p>
                <p>   构造过程：</p>
                <ul>
                    <li>必须包含 $A = \{1,2\}$</li>
                    <li>由封闭性，必须包含 $A^c = \{3,4\}$</li>
                    <li>必须包含 $\emptyset$ 和 $\Omega = \{1,2,3,4\}$</li>
                </ul>
                <p>2. $\sigma(A, B)$ 必须包含：</p>
                <ul>
                    <li>$A = \{1,2\}$, $B = \{2,3\}$</li>
                    <li>$A \cap B = \{2\}$, $A \cup B = \{1,2,3\}$</li>
                    <li>以及它们的补集...</li>
                </ul>
                <p>最终：$\sigma(A, B) = 2^{\Omega}$（幂集，包含所有16个子集）</p>
            </div>
        </div>
        
        <h2>A.2 布朗运动</h2>
        
        <p>布朗运动是随机过程理论的基石，也是扩散模型的数学基础。让我们从物理直觉开始，逐步理解这个美妙的数学对象。</p>
        
        <h3>A.2.1 从花粉到数学：布朗运动的起源</h3>
        
        <p>1827年，植物学家罗伯特·布朗在显微镜下观察悬浮在水中的花粉颗粒，发现它们在不停地做无规则运动。这种运动后来被称为布朗运动。1905年，爱因斯坦从理论上解释了这一现象：花粉的运动是由于水分子的随机碰撞。</p>
        
        <div class="note">
            <strong>物理直觉：</strong>
            <ul>
                <li>每一瞬间，花粉受到来自各个方向的分子碰撞</li>
                <li>碰撞是完全随机的，没有特定方向的偏好</li>
                <li>大量微小的随机碰撞累积成可观察的随机运动</li>
                <li>运动轨迹是连续的，但极其不规则</li>
            </ul>
        </div>
        
        <h3>A.2.2 数学定义</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.5（标准布朗运动）</div>
            随机过程 $\{B_t\}_{t \geq 0}$ 称为标准布朗运动（或维纳过程），如果：
            <ol>
                <li><strong>起点确定</strong>：$B_0 = 0$ a.s.（几乎必然）</li>
                <li><strong>独立增量</strong>：对 $0 \leq t_1 < t_2 < \cdots < t_n$，增量 $B_{t_2}-B_{t_1}, \ldots, B_{t_n}-B_{t_{n-1}}$ 相互独立</li>
                <li><strong>正态增量</strong>：$B_{t+s} - B_t \sim \mathcal{N}(0, s)$ 对所有 $t, s \geq 0$</li>
                <li><strong>轨道连续</strong>：$t \mapsto B_t(\omega)$ 几乎必然连续</li>
            </ol>
        </div>
        
        <p>让我们逐条理解这些性质：</p>
        <ul>
            <li><strong>性质1</strong>：粒子从原点开始</li>
            <li><strong>性质2</strong>：未来的运动与过去无关（马尔可夫性的体现）</li>
            <li><strong>性质3</strong>：任意时间段内的位移服从正态分布，方差与时间成正比</li>
            <li><strong>性质4</strong>：粒子不会"瞬移"，轨迹是连续的</li>
        </ul>
        
        <div class="visualization">
            <p><strong>关键洞察：方差与时间的关系</strong></p>
            <p>为什么是 $\text{Var}(B_t - B_s) = t - s$ 而不是 $(t-s)^2$ 或其他？</p>
            <p>这来自<strong>中心极限定理</strong>：</p>
            <ul>
                <li>将时间段 $[0, t]$ 分成 $n$ 小段</li>
                <li>每小段的位移 $\sim \mathcal{N}(0, t/n)$</li>
                <li>总位移 = $n$ 个独立增量之和</li>
                <li>方差相加：$n \times (t/n) = t$</li>
            </ul>
        </div>
        
        <h3>A.2.3 布朗运动的构造</h3>
        
        <p>布朗运动可以通过多种方式构造。最直观的是<strong>随机游走的极限</strong>：</p>
        
        <div class="visualization">
            <button class="code-toggle" onclick="toggleCode('brownianConstruction')">
                <span>Python代码：从随机游走到布朗运动</span>
            </button>
            <div id="brownianConstruction" class="code-content collapsed">
                <pre><code class="language-python">import numpy as np
import matplotlib.pyplot as plt

def random_walk_to_brownian():
    """展示随机游走如何收敛到布朗运动"""
    fig, axes = plt.subplots(2, 2, figsize=(12, 10))
    axes = axes.flatten()
    
    T = 1.0  # 时间区间
    n_values = [10, 100, 1000, 10000]  # 不同的步数
    
    for idx, n in enumerate(n_values):
        dt = T / n
        t = np.linspace(0, T, n+1)
        
        # 随机游走：每步 ±√dt
        steps = np.random.choice([-1, 1], size=n) * np.sqrt(dt)
        walk = np.concatenate([[0], np.cumsum(steps)])
        
        axes[idx].plot(t, walk, 'b-', alpha=0.7, linewidth=1)
        axes[idx].set_title(f'n = {n} 步')
        axes[idx].set_xlabel('时间 t')
        axes[idx].set_ylabel('位置')
        axes[idx].grid(True, alpha=0.3)
        
        # 添加理论标准差区间
        std_band = np.sqrt(t)
        axes[idx].fill_between(t, -2*std_band, 2*std_band, 
                              alpha=0.2, color='gray', 
                              label='±2σ 区间')
        if idx == 0:
            axes[idx].legend()
    
    plt.suptitle('随机游走收敛到布朗运动', fontsize=16)
    plt.tight_layout()
    plt.show()

# 展示收敛过程
random_walk_to_brownian()

# 模拟真实的布朗运动
def simulate_brownian_motion(T=1.0, N=1000, num_paths=5):
    """模拟多条布朗运动路径"""
    dt = T / N
    t = np.linspace(0, T, N+1)
    
    plt.figure(figsize=(10, 6))
    
    for i in range(num_paths):
        # 生成独立的标准正态增量
        dW = np.sqrt(dt) * np.random.randn(N)
        # 累积和得到布朗运动
        W = np.concatenate([[0], np.cumsum(dW)])
        plt.plot(t, W, alpha=0.7, linewidth=2)
    
    # 添加理论标准差
    plt.fill_between(t, -2*np.sqrt(t), 2*np.sqrt(t), 
                     alpha=0.2, color='gray', label='±2σ 区间')
    
    plt.xlabel('时间 t')
    plt.ylabel('$B_t$')
    plt.title('标准布朗运动的样本路径')
    plt.legend()
    plt.grid(True, alpha=0.3)
    plt.show()

# 模拟布朗运动
simulate_brownian_motion(T=1.0, num_paths=5)</code></pre>
            </div>
        </div>
        
        <h3>A.2.2 布朗运动的性质</h3>
        
        <div class="note">
            <strong>重要性质：</strong>
            <ul>
                <li>$\mathbb{E}[B_t] = 0$（期望为0）</li>
                <li>$\text{Var}(B_t) = t$（方差随时间线性增长）</li>
                <li>$\text{Cov}(B_s, B_t) = \min(s, t)$（协方差结构）</li>
                <li>布朗运动几乎必然处处连续但处处不可微</li>
            </ul>
        </div>
        
        <h2>A.3 随机积分与伊藤公式</h2>
        
        <h3>A.3.1 伊藤积分</h3>
        
        <p>对于适应过程 $f_t$，伊藤积分定义为：</p>
        
        <div class="math-block">
            $$\int_0^t f_s \, dB_s = \lim_{n \to \infty} \sum_{i=0}^{n-1} f_{t_i} (B_{t_{i+1}} - B_{t_i})$$
        </div>
        
        <p>注意这里使用左端点 $f_{t_i}$，这确保了积分的可测性。</p>
        
        <div class="definition">
            <div class="definition-title">定理 A.1（伊藤公式）</div>
            设 $X_t$ 满足 SDE：$dX_t = \mu(X_t, t)dt + \sigma(X_t, t)dB_t$，$f(x, t) \in C^{2,1}$，则：
            $$df(X_t, t) = \left[\frac{\partial f}{\partial t} + \mu \frac{\partial f}{\partial x} + \frac{1}{2}\sigma^2 \frac{\partial^2 f}{\partial x^2}\right]dt + \sigma \frac{\partial f}{\partial x} dB_t$$
        </div>
        
        <p>伊藤公式中的额外项 $\frac{1}{2}\sigma^2 \frac{\partial^2 f}{\partial x^2}$ 来自布朗运动的二次变差 $[B, B]_t = t$。</p>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.2：应用伊藤公式</div>
            <p>设 $B_t$ 是标准布朗运动。使用伊藤公式计算 $d(B_t^2)$。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA2')">显示答案</button>
            <div id="answerA2" class="answer">
                <p><strong>解答：</strong></p>
                <p>设 $f(x, t) = x^2$，$X_t = B_t$，则 $dX_t = dB_t$（即 $\mu = 0, \sigma = 1$）。</p>
                <p>计算偏导数：</p>
                <ul>
                    <li>$\frac{\partial f}{\partial t} = 0$</li>
                    <li>$\frac{\partial f}{\partial x} = 2x$</li>
                    <li>$\frac{\partial^2 f}{\partial x^2} = 2$</li>
                </ul>
                <p>应用伊藤公式：</p>
                $$d(B_t^2) = \left[0 + 0 \cdot 2B_t + \frac{1}{2} \cdot 1^2 \cdot 2\right]dt + 1 \cdot 2B_t \, dB_t$$
                $$= dt + 2B_t \, dB_t$$
                <p>这表明 $B_t^2 - t$ 是一个鞅。</p>
            </div>
        </div>
        
        <h2>A.4 随机微分方程</h2>
        
        <h3>A.4.1 存在性与唯一性</h3>
        
        <div class="definition">
            <div class="definition-title">定理 A.2（存在唯一性定理）</div>
            考虑 SDE：$dX_t = b(X_t, t)dt + \sigma(X_t, t)dB_t$，$X_0 = x_0$。
            如果 $b$ 和 $\sigma$ 满足：
            <ol>
                <li>Lipschitz 条件：$|b(x,t) - b(y,t)| + |\sigma(x,t) - \sigma(y,t)| \leq K|x-y|$</li>
                <li>线性增长条件：$|b(x,t)|^2 + |\sigma(x,t)|^2 \leq K^2(1 + |x|^2)$</li>
            </ol>
            则 SDE 存在唯一的强解。
        </div>
        
        <h3>A.4.2 常见的 SDE</h3>
        
        <p><strong>1. Ornstein-Uhlenbeck 过程：</strong></p>
        <div class="math-block">
            $$dX_t = -\theta X_t dt + \sigma dB_t$$
        </div>
        <p>解：$X_t = e^{-\theta t}X_0 + \sigma \int_0^t e^{-\theta(t-s)} dB_s$</p>
        
        <p><strong>2. 几何布朗运动：</strong></p>
        <div class="math-block">
            $$dX_t = \mu X_t dt + \sigma X_t dB_t$$
        </div>
        <p>解：$X_t = X_0 \exp\left((\mu - \frac{\sigma^2}{2})t + \sigma B_t\right)$</p>
        
        <h2>A.5 与扩散模型的联系</h2>
        
        <p>在扩散模型中，前向过程通常定义为：</p>
        <div class="math-block">
            $$dx = f(x, t)dt + g(t)dB_t$$
        </div>
        
        <p>其中 $f(x, t) = -\frac{1}{2}\beta(t)x$，$g(t) = \sqrt{\beta(t)}$。这是一个时变的 Ornstein-Uhlenbeck 过程。</p>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.3：扩散模型的前向 SDE</div>
            <p>证明扩散模型的前向过程 $dx = -\frac{1}{2}\beta(t)x dt + \sqrt{\beta(t)} dB_t$ 的解为：</p>
            $$x_t = \sqrt{\bar{\alpha}_t} x_0 + \sqrt{1 - \bar{\alpha}_t} \epsilon$$
            <p>其中 $\epsilon \sim \mathcal{N}(0, I)$，$\bar{\alpha}_t = \exp\left(-\int_0^t \beta(s)ds\right)$。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA3')">显示答案</button>
            <div id="answerA3" class="answer">
                <p><strong>提示：</strong></p>
                <ol>
                    <li>使用积分因子方法，令 $y_t = x_t / \sqrt{\bar{\alpha}_t}$</li>
                    <li>应用伊藤公式计算 $dy_t$</li>
                    <li>注意到 $dy_t = \frac{1}{\sqrt{\bar{\alpha}_t}} \sqrt{\beta(t)} dB_t$</li>
                    <li>积分得到 $y_t - y_0 = \int_0^t \frac{\sqrt{\beta(s)}}{\sqrt{\bar{\alpha}_s}} dB_s$</li>
                    <li>计算方差并使用高斯性质得到最终结果</li>
                </ol>
            </div>
        </div>
        
        <h2>A.6 鞅论基础</h2>
        
        <h3>A.6.1 鞅的定义与性质</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.5（鞅）</div>
            随机过程 $\{M_t\}_{t \geq 0}$ 称为关于滤波 $\{\mathcal{F}_t\}$ 的鞅，如果：
            <ol>
                <li>$M_t$ 是 $\mathcal{F}_t$-可测的</li>
                <li>$\mathbb{E}[|M_t|] < \infty$ 对所有 $t \geq 0$</li>
                <li>$\mathbb{E}[M_t | \mathcal{F}_s] = M_s$ 对所有 $0 \leq s \leq t$</li>
            </ol>
        </div>
        
        <p>鞅是"公平游戏"的数学化：给定过去的信息，未来的期望值等于现在的值。</p>
        
        <div class="note">
            <strong>重要例子：</strong>
            <ul>
                <li>布朗运动 $B_t$ 是鞅</li>
                <li>$B_t^2 - t$ 是鞅（补偿布朗运动）</li>
                <li>$\exp(\sigma B_t - \frac{\sigma^2 t}{2})$ 是鞅（指数鞅）</li>
            </ul>
        </div>
        
        <h3>A.6.2 鞅表示定理</h3>
        
        <div class="definition">
            <div class="definition-title">定理 A.3（鞅表示定理）</div>
            设 $M_t$ 是关于布朗运动 $B_t$ 生成的滤波的平方可积鞅。则存在适应过程 $\phi_t$ 使得：
            $$M_t = M_0 + \int_0^t \phi_s dB_s$$
        </div>
        
        <p>这个定理告诉我们，所有的鞅都可以表示为关于布朗运动的随机积分，这在金融数学和扩散模型理论中非常重要。</p>
        
        <h3>A.6.3 Doob-Meyer 分解</h3>
        
        <p>任何连续半鞅 $X_t$ 都可以唯一分解为：</p>
        <div class="math-block">
            $$X_t = X_0 + M_t + A_t$$
        </div>
        <p>其中 $M_t$ 是局部鞅，$A_t$ 是有界变差过程。</p>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.4：验证鞅性质</div>
            <p>证明过程 $M_t = \int_0^t s dB_s$ 是鞅，并计算其二次变差 $\langle M \rangle_t$。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA4')">显示答案</button>
            <div id="answerA4" class="answer">
                <p><strong>解答：</strong></p>
                <p>1. 验证鞅性质：对 $s < t$，</p>
                $$\mathbb{E}[M_t | \mathcal{F}_s] = \mathbb{E}\left[\int_0^t u dB_u \bigg| \mathcal{F}_s\right]$$
                $$= \int_0^s u dB_u + \mathbb{E}\left[\int_s^t u dB_u \bigg| \mathcal{F}_s\right]$$
                $$= M_s + 0 = M_s$$
                <p>2. 计算二次变差：</p>
                $$\langle M \rangle_t = \int_0^t s^2 ds = \frac{t^3}{3}$$
            </div>
        </div>
        
        <h2>A.7 Girsanov 定理与测度变换</h2>
        
        <h3>A.7.1 Radon-Nikodym 导数</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.6（Radon-Nikodym 导数）</div>
            设 $\mathbb{P}$ 和 $\mathbb{Q}$ 是概率测度，如果 $\mathbb{Q} \ll \mathbb{P}$（$\mathbb{Q}$ 关于 $\mathbb{P}$ 绝对连续），则存在 $\mathcal{F}$-可测的非负随机变量 $Z$，使得：
            $$\mathbb{Q}(A) = \mathbb{E}^{\mathbb{P}}[Z \mathbf{1}_A]$$
            $Z$ 称为 Radon-Nikodym 导数，记为 $\frac{d\mathbb{Q}}{d\mathbb{P}}$。
        </div>
        
        <h3>A.7.2 Girsanov 定理</h3>
        
        <div class="definition">
            <div class="definition-title">定理 A.4（Girsanov 定理）</div>
            设 $\theta_t$ 是适应过程，满足 Novikov 条件。定义：
            $$Z_t = \exp\left(-\int_0^t \theta_s dB_s - \frac{1}{2}\int_0^t \theta_s^2 ds\right)$$
            在新测度 $\mathbb{Q}$ 下（$\frac{d\mathbb{Q}}{d\mathbb{P}}\big|_{\mathcal{F}_t} = Z_t$），过程：
            $$\tilde{B}_t = B_t + \int_0^t \theta_s ds$$
            是标准布朗运动。
        </div>
        
        <p>Girsanov 定理允许我们改变概率测度，从而改变漂移项。这在扩散模型的理论分析中非常重要。</p>
        
        <h2>A.8 Fokker-Planck 方程与 Kolmogorov 方程</h2>
        
        <h3>A.8.1 Fokker-Planck 方程</h3>
        
        <p>对于 SDE $dX_t = b(X_t, t)dt + \sigma(X_t, t)dB_t$，其概率密度 $p(x, t)$ 满足 Fokker-Planck 方程（也称为前向 Kolmogorov 方程）：</p>
        
        <div class="math-block">
            $$\frac{\partial p}{\partial t} = -\nabla \cdot (b p) + \frac{1}{2}\nabla^2 : (\sigma \sigma^T p)$$
        </div>
        
        <p>在一维情况下：</p>
        <div class="math-block">
            $$\frac{\partial p}{\partial t} = -\frac{\partial}{\partial x}(b(x,t) p) + \frac{1}{2}\frac{\partial^2}{\partial x^2}(\sigma^2(x,t) p)$$
        </div>
        
        <h3>A.8.2 后向 Kolmogorov 方程</h3>
        
        <p>对于函数 $u(x, t) = \mathbb{E}[f(X_T) | X_t = x]$，它满足后向 Kolmogorov 方程：</p>
        
        <div class="math-block">
            $$\frac{\partial u}{\partial t} + b(x,t)\frac{\partial u}{\partial x} + \frac{1}{2}\sigma^2(x,t)\frac{\partial^2 u}{\partial x^2} = 0$$
        </div>
        
        <p>边界条件：$u(x, T) = f(x)$。</p>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.5：Ornstein-Uhlenbeck 过程的稳态分布</div>
            <p>使用 Fokker-Planck 方程求解 OU 过程 $dX_t = -\theta X_t dt + \sigma dB_t$ 的稳态分布。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA5')">显示答案</button>
            <div id="answerA5" class="answer">
                <p><strong>解答：</strong></p>
                <p>稳态时 $\frac{\partial p}{\partial t} = 0$，Fokker-Planck 方程变为：</p>
                $$0 = \frac{\partial}{\partial x}(\theta x p) + \frac{\sigma^2}{2}\frac{\partial^2 p}{\partial x^2}$$
                <p>令概率流 $J = -\theta x p - \frac{\sigma^2}{2}\frac{\partial p}{\partial x} = 0$（稳态无净流）</p>
                <p>解得：$p(x) \propto \exp\left(-\frac{\theta x^2}{\sigma^2}\right)$</p>
                <p>归一化后得到稳态分布：$p(x) = \sqrt{\frac{\theta}{\pi \sigma^2}} \exp\left(-\frac{\theta x^2}{\sigma^2}\right)$</p>
                <p>即 $X_\infty \sim \mathcal{N}\left(0, \frac{\sigma^2}{2\theta}\right)$。</p>
            </div>
        </div>
        
        <h2>A.9 随机分析的高级主题</h2>
        
        <h3>A.9.1 局部时与 Tanaka 公式</h3>
        
        <p>布朗运动在 0 点的局部时 $L_t^0$ 测量布朗运动在 0 附近花费的时间：</p>
        <div class="math-block">
            $$L_t^0 = \lim_{\epsilon \to 0} \frac{1}{2\epsilon} \int_0^t \mathbf{1}_{|B_s| < \epsilon} ds$$
        </div>
        
        <div class="definition">
            <div class="definition-title">定理 A.5（Tanaka 公式）</div>
            对于布朗运动 $B_t$：
            $$|B_t| = \int_0^t \text{sgn}(B_s) dB_s + L_t^0$$
        </div>
        
        <h3>A.9.2 反射布朗运动</h3>
        
        <p>反射布朗运动 $|B_t|$ 在 0 处被反射。它的生成元是：</p>
        <div class="math-block">
            $$\mathcal{L} = \frac{1}{2}\frac{d^2}{dx^2}, \quad x > 0$$
        </div>
        <p>边界条件：$\frac{\partial u}{\partial x}(0) = 0$（Neumann 边界条件）。</p>
        
        <h3>A.9.3 Bessel 过程</h3>
        
        <p>$n$ 维 Bessel 过程定义为 $n$ 维布朗运动的范数：$R_t = |B_t^{(n)}|$。它满足：</p>
        <div class="math-block">
            $$dR_t = \frac{n-1}{2R_t}dt + dW_t$$
        </div>
        <p>其中 $W_t$ 是一维布朗运动。</p>
        
        <h2>A.10 数值方法</h2>
        
        <h3>A.10.1 Euler-Maruyama 方法</h3>
        
        <p>对于 SDE $dX_t = b(X_t)dt + \sigma(X_t)dB_t$，Euler-Maruyama 离散化为：</p>
        <div class="math-block">
            $$X_{n+1} = X_n + b(X_n)\Delta t + \sigma(X_n)\sqrt{\Delta t} Z_n$$
        </div>
        <p>其中 $Z_n \sim \mathcal{N}(0, 1)$ 独立同分布。</p>
        
        <h3>A.10.2 Milstein 方法</h3>
        
        <p>更高阶的 Milstein 方法包含伊藤修正项：</p>
        <div class="math-block">
            $$X_{n+1} = X_n + b(X_n)\Delta t + \sigma(X_n)\sqrt{\Delta t} Z_n + \frac{1}{2}\sigma(X_n)\sigma'(X_n)\Delta t(Z_n^2 - 1)$$
        </div>
        
        <div class="code-collapsible">
            <button class="code-toggle collapsed" onclick="toggleCode('sdeNumericalCode')">
                <span>Python代码：SDE数值方法比较</span>
            </button>
            <div id="sdeNumericalCode" class="code-content collapsed">
                <pre><code class="language-python">import numpy as np
import matplotlib.pyplot as plt

def euler_maruyama(x0, drift, diffusion, T, N):
    """Euler-Maruyama方法"""
    dt = T / N
    X = np.zeros(N + 1)
    X[0] = x0
    
    for i in range(N):
        dW = np.sqrt(dt) * np.random.randn()
        X[i+1] = X[i] + drift(X[i]) * dt + diffusion(X[i]) * dW
    
    return X

def milstein(x0, drift, diffusion, diffusion_prime, T, N):
    """Milstein方法"""
    dt = T / N
    X = np.zeros(N + 1)
    X[0] = x0
    
    for i in range(N):
        Z = np.random.randn()
        dW = np.sqrt(dt) * Z
        X[i+1] = X[i] + drift(X[i]) * dt + diffusion(X[i]) * dW + \
                 0.5 * diffusion(X[i]) * diffusion_prime(X[i]) * dt * (Z**2 - 1)
    
    return X

# 测试：几何布朗运动
# dX_t = μX_t dt + σX_t dB_t
μ, σ = 0.1, 0.3
drift = lambda x: μ * x
diffusion = lambda x: σ * x
diffusion_prime = lambda x: σ

# 解析解
def analytical_solution(x0, t, W):
    return x0 * np.exp((μ - 0.5 * σ**2) * t + σ * W)

# 模拟参数
x0, T, N = 1.0, 1.0, 1000
t = np.linspace(0, T, N + 1)

# 多次模拟比较误差
n_simulations = 100
euler_errors = []
milstein_errors = []

for _ in range(n_simulations):
    # 生成布朗运动路径
    dW = np.sqrt(T/N) * np.random.randn(N)
    W = np.concatenate([[0], np.cumsum(dW)])
    
    # 真实解
    X_true = analytical_solution(x0, t, W)
    
    # Euler-Maruyama
    X_euler = euler_maruyama(x0, drift, diffusion, T, N)
    euler_errors.append(np.abs(X_euler[-1] - X_true[-1]))
    
    # Milstein
    X_milstein = milstein(x0, drift, diffusion, diffusion_prime, T, N)
    milstein_errors.append(np.abs(X_milstein[-1] - X_true[-1]))

print(f"Euler-Maruyama 平均误差: {np.mean(euler_errors):.6f}")
print(f"Milstein 平均误差: {np.mean(milstein_errors):.6f}")

# 绘制一条样本路径
plt.figure(figsize=(10, 6))
plt.plot(t, X_true, 'k-', label='解析解', linewidth=2)
plt.plot(t, X_euler, 'b--', label='Euler-Maruyama', alpha=0.7)
plt.plot(t, X_milstein, 'r:', label='Milstein', alpha=0.7)
plt.xlabel('时间 t')
plt.ylabel('X(t)')
plt.title('SDE数值方法比较')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()</code></pre>
            </div>
        </div>
        
        <h2>A.11 与扩散模型的深层联系</h2>
        
        <h3>A.11.1 Score函数与漂移项</h3>
        
        <p>在扩散模型中，反向SDE的漂移项包含score函数 $\nabla_x \log p_t(x)$：</p>
        <div class="math-block">
            $$dx = \left[f(x, t) - g^2(t)\nabla_x \log p_t(x)\right]dt + g(t)d\bar{B}_t$$
        </div>
        
        <p>这里的score函数满足：</p>
        <div class="math-block">
            $$\nabla_x \log p_t(x) = -\frac{1}{\sqrt{1-\bar{\alpha}_t}}\mathbb{E}[\epsilon | x_t = x]$$
        </div>
        
        <h3>A.11.2 时间反演与伴随过程</h3>
        
        <p>对于前向SDE，其时间反演过程（从 $t=T$ 到 $t=0$）由Anderson定理给出。这正是扩散模型反向过程的理论基础。</p>
        
        <div class="exercise">
            <div class="exercise-title">综合练习：推导扩散模型的反向SDE</div>
            <p>从前向SDE $dx = -\frac{1}{2}\beta(t)x dt + \sqrt{\beta(t)} dB_t$ 出发，使用时间反演理论推导反向SDE。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA_final')">显示答案</button>
            <div id="answerA_final" class="answer">
                <p><strong>提示：</strong></p>
                <ol>
                    <li>写出前向过程的Fokker-Planck方程</li>
                    <li>使用Anderson定理，反向漂移项为：$b_{rev} = -b_{for} + \sigma^2 \nabla \log p_t$</li>
                    <li>计算score函数 $\nabla \log p_t(x)$</li>
                    <li>代入得到反向SDE</li>
                </ol>
                <p>关键洞察：score函数编码了数据分布的信息，学习score函数等价于学习如何去噪。</p>
            </div>
        </div>
        
        <h2>A.12 进一步学习资源</h2>
        
        <div class="note">
            <strong>推荐阅读：</strong>
            <ul>
                <li>Øksendal, B. "Stochastic Differential Equations" - SDE 的经典教材</li>
                <li>Karatzas, I. & Shreve, S. "Brownian Motion and Stochastic Calculus" - 更深入的理论</li>
                <li>Evans, L.C. "An Introduction to Stochastic Differential Equations" - 适合初学者</li>
            </ul>
        </div>
        
        <div class="chapter-summary">
            <h2>本章小结</h2>
            <p>在本附录中，我们快速回顾了理解连续时间扩散模型所需的数学基础：</p>
            <ul>
                <li>测度论提供了处理连续随机变量的严格框架</li>
                <li>布朗运动是扩散过程的基本构建块</li>
                <li>伊藤公式是随机微积分的链式法则，包含额外的二阶项</li>
                <li>SDE 描述了随机系统的演化，扩散模型的前向过程就是一个 SDE</li>
            </ul>
            <p>这些工具将在第5章中用于理解扩散模型的连续时间公式化，特别是 Score-based SDE 框架。</p>
        </div>
    </div>
</body>
</html>
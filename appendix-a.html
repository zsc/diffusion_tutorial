<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>附录A：测度论与随机过程速成 - Diffusion Models Tutorial</title>
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    <script defer src="common.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <a href="index.html">← 返回目录</a>
            <span>附录A</span>
            <a href="appendix-b.html">附录B →</a>
        </div>
        
        <h1>附录A：测度论与随机过程速成</h1>
        
        <div class="chapter-intro">
            本附录为理解第5章（连续时间扩散模型）提供必要的数学基础。我们将快速回顾测度论的核心概念，介绍布朗运动和随机微分方程的基本知识。这不是完整的数学课程，而是为理解扩散模型所需的最小知识集。
        </div>
        
        <h2>A.1 测度论基础</h2>
        
        <h3>A.1.1 为什么需要测度论？</h3>
        
        <p>让我们从一个简单但深刻的问题开始：<strong>在区间[0,1]上随机选一个点，这个点恰好是有理数的概率是多少？</strong></p>
        
        <p>你的直觉可能会说："有理数有无穷多个，所以概率应该很大。"但实际上，这个概率是0！这个反直觉的结果揭示了我们需要一个比传统概率论更精细的数学框架。</p>
        
        <div class="note">
            <strong>直观理解：</strong>想象你在数轴上随机投掷飞镖。虽然有理数密密麻麻地分布在数轴上（任意两个不同的实数之间都有无穷多个有理数），但它们太"稀疏"了——就像在无限的海洋中撒了无限多粒沙子，但每粒沙子都是孤立的点，没有"体积"。
        </div>
        
        <p>测度论正是为了严格处理这类"无穷"而诞生的。它不仅能处理"长度"、"面积"、"体积"，还能处理更抽象的"大小"概念。在随机过程中，我们需要测度论来：</p>
        <ul>
            <li>定义什么是"随机事件"（可测集）</li>
            <li>给事件赋予"概率"（测度）</li>
            <li>处理连续时间上的无穷多个随机变量</li>
            <li>严格定义条件期望和鞅</li>
        </ul>
        
        <h3>A.1.2 σ-代数：可测量的事件</h3>
        
        <p>在概率论中，不是所有的子集都能被赋予概率。我们需要一个"合理"的集合族来定义哪些事件是可测的。</p>
        
        <div class="definition">
            <div class="definition-title">定义 A.1（σ-代数）</div>
            设 $\Omega$ 是一个非空集合（样本空间）。$\Omega$ 的子集族 $\mathcal{F}$ 称为 σ-代数，如果：
            <ol>
                <li>$\Omega \in \mathcal{F}$（全集可测）</li>
                <li>若 $A \in \mathcal{F}$，则 $A^c \in \mathcal{F}$（对补运算封闭）</li>
                <li>若 $A_1, A_2, \ldots \in \mathcal{F}$，则 $\bigcup_{i=1}^{\infty} A_i \in \mathcal{F}$（对可数并封闭）</li>
            </ol>
        </div>
        
        <p>σ-代数的三个条件可以理解为：</p>
        <ul>
            <li><strong>条件1</strong>：必然事件是可测的</li>
            <li><strong>条件2</strong>：如果事件A可测，那么"A不发生"也应该可测</li>
            <li><strong>条件3</strong>：如果每个事件都可测，那么"至少有一个发生"也应该可测</li>
        </ul>
        
        <div class="visualization">
            <p><strong>例子：掷硬币的σ-代数</strong></p>
            <p>考虑掷一次硬币，$\Omega = \{H, T\}$（H=正面，T=反面）</p>
            <p>最小的σ-代数（平凡σ-代数）：$\mathcal{F}_1 = \{\emptyset, \{H, T\}\}$</p>
            <p>最大的σ-代数（幂集）：$\mathcal{F}_2 = \{\emptyset, \{H\}, \{T\}, \{H, T\}\}$</p>
            <p>注意：$\{\emptyset, \{H\}\}$ 不是σ-代数，因为缺少 $\{H\}^c = \{T\}$</p>
        </div>
        
        <h3>A.1.3 测度：给集合赋予"大小"</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.2（测度）</div>
            测度 $\mu: \mathcal{F} \rightarrow [0, \infty]$ 是满足以下条件的函数：
            <ol>
                <li>$\mu(\emptyset) = 0$（空集的测度为0）</li>
                <li>可数可加性：对于两两不交的 $A_1, A_2, \ldots \in \mathcal{F}$，
                    $$\mu\left(\bigcup_{i=1}^{\infty} A_i\right) = \sum_{i=1}^{\infty} \mu(A_i)$$</li>
            </ol>
        </div>
        
        <p>测度推广了我们熟悉的概念：</p>
        <ul>
            <li><strong>长度</strong>：实数轴上的Lebesgue测度，$\mu([a,b]) = b - a$</li>
            <li><strong>面积</strong>：平面上的二维Lebesgue测度</li>
            <li><strong>概率</strong>：当 $\mu(\Omega) = 1$ 时，$\mu$ 称为概率测度 $\mathbb{P}$</li>
            <li><strong>计数</strong>：计数测度，$\mu(A) = |A|$（集合中元素的个数）</li>
        </ul>
        
        <div class="note">
            <strong>关键洞察：</strong>测度的可数可加性是其最重要的性质。它说明了为什么有理数在实数中的测度为0：
            <ul>
                <li>每个单点集 $\{r\}$ 的Lebesgue测度为0</li>
                <li>有理数集 $\mathbb{Q} \cap [0,1]$ 是可数个单点的并</li>
                <li>由可数可加性：$\mu(\mathbb{Q} \cap [0,1]) = \sum_{r \in \mathbb{Q} \cap [0,1]} \mu(\{r\}) = \sum 0 = 0$</li>
            </ul>
        </div>
        
        <h3>A.1.4 可测函数与随机变量</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.3（随机变量）</div>
            设 $(\Omega, \mathcal{F}, \mathbb{P})$ 是概率空间。函数 $X: \Omega \rightarrow \mathbb{R}$ 称为随机变量，如果对任意 Borel 集 $B \subseteq \mathbb{R}$，有
            $$X^{-1}(B) = \{\omega \in \Omega : X(\omega) \in B\} \in \mathcal{F}$$
        </div>
        
        <p>这个定义看起来抽象，但其核心思想很简单：<strong>随机变量必须与我们的σ-代数兼容</strong>。</p>
        
        <div class="visualization">
            <p><strong>例子：掷骰子的随机变量</strong></p>
            <p>$\Omega = \{1, 2, 3, 4, 5, 6\}$，$\mathcal{F} = 2^{\Omega}$（幂集）</p>
            <p>定义随机变量 $X(\omega) = \omega$（点数本身）</p>
            <p>事件"点数大于4" = $\{\omega: X(\omega) > 4\} = \{5, 6\} \in \mathcal{F}$ ✓</p>
            <p>定义另一个随机变量 $Y(\omega) = \begin{cases} 1 & \text{if } \omega \text{ 是偶数} \\ 0 & \text{if } \omega \text{ 是奇数} \end{cases}$</p>
            <p>$Y$ 将骰子结果映射到"奇偶性"，仍然是可测的</p>
        </div>
        
        <p>在连续情况下，Borel σ-代数包含了所有"常见"的集合（开区间、闭区间、单点等），所以实践中几乎所有函数都是可测的。</p>
        
        <h3>A.1.5 条件期望与滤波</h3>
        
        <p>在随机过程中，我们经常需要基于"部分信息"进行预测。这就是条件期望的作用。</p>
        
        <div class="definition">
            <div class="definition-title">定义 A.4（滤波）</div>
            滤波（filtration）$\{\mathcal{F}_t\}_{t \geq 0}$ 是一族递增的σ-代数：
            $$\mathcal{F}_s \subseteq \mathcal{F}_t \subseteq \mathcal{F}, \quad \forall s \leq t$$
        </div>
        
        <p>滤波代表"信息的累积"：$\mathcal{F}_t$ 包含了到时刻 $t$ 为止的所有可观测信息。</p>
        
        <div class="note">
            <strong>直观理解：</strong>想象你在观看一场足球比赛：
            <ul>
                <li>$\mathcal{F}_0$：比赛开始前的信息（球队阵容等）</li>
                <li>$\mathcal{F}_{45}$：上半场结束时的信息（比分、黄牌等）</li>
                <li>$\mathcal{F}_{90}$：全场比赛的完整信息</li>
            </ul>
            随着时间推进，你知道的信息越来越多，但不会"忘记"之前的信息。
        </div>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.1：构造σ-代数</div>
            <p>设 $\Omega = \{1, 2, 3, 4\}$，事件 $A = \{1, 2\}$。</p>
            <ol>
                <li>构造包含 $A$ 的最小σ-代数 $\sigma(A)$</li>
                <li>如果再加入事件 $B = \{2, 3\}$，最小σ-代数 $\sigma(A, B)$ 是什么？</li>
            </ol>
            <button class="answer-toggle" onclick="toggleAnswer('answerA1')">显示答案</button>
            <div id="answerA1" class="answer">
                <p><strong>解答：</strong></p>
                <p>1. $\sigma(A) = \{\emptyset, \{1,2\}, \{3,4\}, \{1,2,3,4\}\}$</p>
                <p>   构造过程：</p>
                <ul>
                    <li>必须包含 $A = \{1,2\}$</li>
                    <li>由封闭性，必须包含 $A^c = \{3,4\}$</li>
                    <li>必须包含 $\emptyset$ 和 $\Omega = \{1,2,3,4\}$</li>
                </ul>
                <p>2. $\sigma(A, B)$ 必须包含：</p>
                <ul>
                    <li>$A = \{1,2\}$, $B = \{2,3\}$</li>
                    <li>$A \cap B = \{2\}$, $A \cup B = \{1,2,3\}$</li>
                    <li>以及它们的补集...</li>
                </ul>
                <p>最终：$\sigma(A, B) = 2^{\Omega}$（幂集，包含所有16个子集）</p>
            </div>
        </div>
        
        <h2>A.2 布朗运动</h2>
        
        <p>布朗运动是随机过程理论的基石，也是扩散模型的数学基础。让我们从物理直觉开始，逐步理解这个美妙的数学对象。</p>
        
        <h3>A.2.1 从花粉到数学：布朗运动的起源</h3>
        
        <p>1827年，植物学家罗伯特·布朗在显微镜下观察悬浮在水中的花粉颗粒，发现它们在不停地做无规则运动。这种运动后来被称为布朗运动。1905年，爱因斯坦从理论上解释了这一现象：花粉的运动是由于水分子的随机碰撞。</p>
        
        <div class="note">
            <strong>物理直觉：</strong>
            <ul>
                <li>每一瞬间，花粉受到来自各个方向的分子碰撞</li>
                <li>碰撞是完全随机的，没有特定方向的偏好</li>
                <li>大量微小的随机碰撞累积成可观察的随机运动</li>
                <li>运动轨迹是连续的，但极其不规则</li>
            </ul>
        </div>
        
        <h3>A.2.2 数学定义</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.5（标准布朗运动）</div>
            随机过程 $\{B_t\}_{t \geq 0}$ 称为标准布朗运动（或维纳过程），如果：
            <ol>
                <li><strong>起点确定</strong>：$B_0 = 0$ a.s.（几乎必然）</li>
                <li><strong>独立增量</strong>：对 $0 \leq t_1 < t_2 < \cdots < t_n$，增量 $B_{t_2}-B_{t_1}, \ldots, B_{t_n}-B_{t_{n-1}}$ 相互独立</li>
                <li><strong>正态增量</strong>：$B_{t+s} - B_t \sim \mathcal{N}(0, s)$ 对所有 $t, s \geq 0$</li>
                <li><strong>轨道连续</strong>：$t \mapsto B_t(\omega)$ 几乎必然连续</li>
            </ol>
        </div>
        
        <p>让我们逐条理解这些性质：</p>
        <ul>
            <li><strong>性质1</strong>：粒子从原点开始</li>
            <li><strong>性质2</strong>：未来的运动与过去无关（马尔可夫性的体现）</li>
            <li><strong>性质3</strong>：任意时间段内的位移服从正态分布，方差与时间成正比</li>
            <li><strong>性质4</strong>：粒子不会"瞬移"，轨迹是连续的</li>
        </ul>
        
        <div class="visualization">
            <p><strong>关键洞察：方差与时间的关系</strong></p>
            <p>为什么是 $\text{Var}(B_t - B_s) = t - s$ 而不是 $(t-s)^2$ 或其他？</p>
            <p>这来自<strong>中心极限定理</strong>：</p>
            <ul>
                <li>将时间段 $[0, t]$ 分成 $n$ 小段</li>
                <li>每小段的位移 $\sim \mathcal{N}(0, t/n)$</li>
                <li>总位移 = $n$ 个独立增量之和</li>
                <li>方差相加：$n \times (t/n) = t$</li>
            </ul>
        </div>
        
        <h3>A.2.3 布朗运动的构造</h3>
        
        <p>布朗运动可以通过多种方式构造。最直观的是<strong>随机游走的极限</strong>：</p>
        
        <div class="visualization">
            <button class="code-toggle" onclick="toggleCode('brownianConstruction')">
                <span>Python代码：从随机游走到布朗运动</span>
            </button>
            <div id="brownianConstruction" class="code-content collapsed">
                <pre><code class="language-python">import numpy as np
import matplotlib.pyplot as plt

def random_walk_to_brownian():
    """展示随机游走如何收敛到布朗运动"""
    fig, axes = plt.subplots(2, 2, figsize=(12, 10))
    axes = axes.flatten()
    
    T = 1.0  # 时间区间
    n_values = [10, 100, 1000, 10000]  # 不同的步数
    
    for idx, n in enumerate(n_values):
        dt = T / n
        t = np.linspace(0, T, n+1)
        
        # 随机游走：每步 ±√dt
        steps = np.random.choice([-1, 1], size=n) * np.sqrt(dt)
        walk = np.concatenate([[0], np.cumsum(steps)])
        
        axes[idx].plot(t, walk, 'b-', alpha=0.7, linewidth=1)
        axes[idx].set_title(f'n = {n} 步')
        axes[idx].set_xlabel('时间 t')
        axes[idx].set_ylabel('位置')
        axes[idx].grid(True, alpha=0.3)
        
        # 添加理论标准差区间
        std_band = np.sqrt(t)
        axes[idx].fill_between(t, -2*std_band, 2*std_band, 
                              alpha=0.2, color='gray', 
                              label='±2σ 区间')
        if idx == 0:
            axes[idx].legend()
    
    plt.suptitle('随机游走收敛到布朗运动', fontsize=16)
    plt.tight_layout()
    plt.show()

# 展示收敛过程
random_walk_to_brownian()

# 模拟真实的布朗运动
def simulate_brownian_motion(T=1.0, N=1000, num_paths=5):
    """模拟多条布朗运动路径"""
    dt = T / N
    t = np.linspace(0, T, N+1)
    
    plt.figure(figsize=(10, 6))
    
    for i in range(num_paths):
        # 生成独立的标准正态增量
        dW = np.sqrt(dt) * np.random.randn(N)
        # 累积和得到布朗运动
        W = np.concatenate([[0], np.cumsum(dW)])
        plt.plot(t, W, alpha=0.7, linewidth=2)
    
    # 添加理论标准差
    plt.fill_between(t, -2*np.sqrt(t), 2*np.sqrt(t), 
                     alpha=0.2, color='gray', label='±2σ 区间')
    
    plt.xlabel('时间 t')
    plt.ylabel('$B_t$')
    plt.title('标准布朗运动的样本路径')
    plt.legend()
    plt.grid(True, alpha=0.3)
    plt.show()

# 模拟布朗运动
simulate_brownian_motion(T=1.0, num_paths=5)</code></pre>
            </div>
        </div>
        
        <h3>A.2.4 布朗运动的深刻性质</h3>
        
        <div class="note">
            <strong>基本统计性质：</strong>
            <ul>
                <li>$\mathbb{E}[B_t] = 0$（期望始终为0）</li>
                <li>$\text{Var}(B_t) = t$（方差随时间线性增长）</li>
                <li>$\text{Cov}(B_s, B_t) = \min(s, t)$（协方差等于较早的时间）</li>
            </ul>
        </div>
        
        <p>让我们推导协方差公式，这个推导揭示了布朗运动的本质：</p>
        <div class="math-block">
            $$\text{Cov}(B_s, B_t) = \mathbb{E}[B_s B_t] - \mathbb{E}[B_s]\mathbb{E}[B_t] = \mathbb{E}[B_s B_t]$$
        </div>
        <p>不失一般性，设 $s < t$，则：</p>
        <div class="math-block">
            $$B_t = B_s + (B_t - B_s)$$
        </div>
        <p>因此：</p>
        <div class="math-block">
            $$\mathbb{E}[B_s B_t] = \mathbb{E}[B_s(B_s + (B_t - B_s))] = \mathbb{E}[B_s^2] + \mathbb{E}[B_s]\mathbb{E}[B_t - B_s] = s + 0 = s$$
        </div>
        
        <div class="warning">
            <strong>布朗运动的病态性质：</strong>
            <p>布朗运动几乎必然：</p>
            <ul>
                <li><strong>处处连续</strong>：轨道没有跳跃</li>
                <li><strong>处处不可微</strong>：在任何点都没有切线！</li>
                <li><strong>无界变差</strong>：在任意有限区间上的总变差都是无穷大</li>
                <li><strong>Hölder连续</strong>：对任意 $\alpha < 1/2$，存在常数 $C$ 使得 $|B_t - B_s| \leq C|t-s|^{\alpha}$</li>
            </ul>
        </div>
        
        <p>这些性质看似矛盾——连续但不可微？让我们通过一个直观的论证理解这一点：</p>
        
        <div class="visualization">
            <p><strong>为什么布朗运动不可微？</strong></p>
            <p>假设在 $t$ 点可微，即存在导数：</p>
            $$B'(t) = \lim_{h \to 0} \frac{B_{t+h} - B_t}{h}$$
            <p>但是 $B_{t+h} - B_t \sim \mathcal{N}(0, h)$，所以：</p>
            $$\frac{B_{t+h} - B_t}{h} \sim \mathcal{N}(0, 1/h)$$
            <p>当 $h \to 0$ 时，方差 $1/h \to \infty$！</p>
            <p>这意味着"导数"的分布越来越分散，不会收敛到任何确定的值。</p>
        </div>
        
        <h3>A.2.5 布朗运动的变形</h3>
        
        <p>除了标准布朗运动，实践中还常用其他形式：</p>
        
        <div class="definition">
            <div class="definition-title">定义 A.6（带漂移的布朗运动）</div>
            $$X_t = \mu t + \sigma B_t$$
            其中 $\mu$ 是漂移率，$\sigma$ 是扩散系数。
        </div>
        
        <div class="definition">
            <div class="definition-title">定义 A.7（几何布朗运动）</div>
            $$S_t = S_0 \exp\left((\mu - \frac{\sigma^2}{2})t + \sigma B_t\right)$$
            用于建模股票价格等始终为正的量。
        </div>
        
        <div class="definition">
            <div class="definition-title">定义 A.8（布朗桥）</div>
            条件布朗运动 $B_t^{bridge}$，满足 $B_0^{bridge} = 0$ 和 $B_1^{bridge} = 0$。
            $$B_t^{bridge} = B_t - t B_1, \quad t \in [0, 1]$$
        </div>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.2：布朗运动的性质</div>
            <p>1. 证明：如果 $B_t$ 是标准布朗运动，则 $-B_t$ 也是标准布朗运动。</p>
            <p>2. 证明：$W_t = \frac{1}{c}B_{c^2 t}$ 对任意 $c > 0$ 都是标准布朗运动（尺度不变性）。</p>
            <p>3. 计算 $\mathbb{E}[B_t^4]$。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA2')">显示答案</button>
            <div id="answerA2" class="answer">
                <p><strong>解答：</strong></p>
                <p>1. 验证四个性质：</p>
                <ul>
                    <li>$(-B)_0 = -B_0 = 0$ ✓</li>
                    <li>$(-B)_{t+s} - (-B)_t = -(B_{t+s} - B_t) \sim \mathcal{N}(0, s)$ ✓</li>
                    <li>独立增量和连续性也保持 ✓</li>
                </ul>
                <p>2. 验证 $W_t$ 的增量：</p>
                $$W_{t+s} - W_t = \frac{1}{c}(B_{c^2(t+s)} - B_{c^2 t}) = \frac{1}{c}B_{c^2 s} \sim \mathcal{N}(0, s)$$
                <p>3. 使用 $B_t \sim \mathcal{N}(0, t)$ 和正态分布的四阶矩公式：</p>
                $$\mathbb{E}[B_t^4] = 3(\text{Var}(B_t))^2 = 3t^2$$
            </div>
        </div>
        
        <h2>A.3 随机积分与伊藤公式</h2>
        
        <p>现在我们进入随机微积分的核心——如何对布朗运动进行积分？这个问题比看起来更微妙。</p>
        
        <h3>A.3.1 为什么需要伊藤积分？</h3>
        
        <p>考虑积分 $\int_0^t B_s \, dB_s$。在普通微积分中，我们会说这等于 $\frac{1}{2}B_t^2$，但这在随机情况下是<strong>错误的</strong>！</p>
        
        <div class="visualization">
            <p><strong>问题的根源：</strong></p>
            <p>对于黎曼积分，我们用矩形近似：</p>
            $$\int_0^t f(s) \, ds \approx \sum_{i=0}^{n-1} f(\xi_i) \Delta s_i$$
            <p>其中 $\xi_i \in [s_i, s_{i+1}]$ 可以任意选择（左端点、右端点、中点等）。</p>
            <p>但对于 $\int_0^t B_s \, dB_s$，不同的选择会导致<strong>不同的极限</strong>：</p>
            <ul>
                <li>左端点（伊藤）：$\xi_i = s_i$ → 极限 = $\frac{1}{2}B_t^2 - \frac{1}{2}t$</li>
                <li>右端点：$\xi_i = s_{i+1}$ → 极限 = $\frac{1}{2}B_t^2 + \frac{1}{2}t$</li>
                <li>中点（Stratonovich）：$\xi_i = \frac{s_i + s_{i+1}}{2}$ → 极限 = $\frac{1}{2}B_t^2$</li>
            </ul>
        </div>
        
        <h3>A.3.2 伊藤积分的定义</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.9（伊藤积分）</div>
            对于适应过程 $f_t$（即 $f_t$ 只依赖于到时刻 $t$ 为止的信息），伊藤积分定义为：
            $$\int_0^t f_s \, dB_s = \lim_{n \to \infty} \sum_{i=0}^{n-1} f_{t_i} (B_{t_{i+1}} - B_{t_i})$$
            使用左端点 $f_{t_i}$ 确保了"不能预见未来"。
        </div>
        
        <p>为什么选择左端点？这确保了积分的<strong>鞅性质</strong>：</p>
        <div class="math-block">
            $$\mathbb{E}\left[\int_0^t f_s \, dB_s\right] = 0$$
        </div>
        
        <div class="note">
            <strong>伊藤积分的关键性质：</strong>
            <ul>
                <li><strong>线性性</strong>：$\int (af + bg) \, dB = a\int f \, dB + b\int g \, dB$</li>
                <li><strong>伊藤等距</strong>：$\mathbb{E}\left[\left(\int_0^t f_s \, dB_s\right)^2\right] = \mathbb{E}\left[\int_0^t f_s^2 \, ds\right]$</li>
                <li><strong>鞅性</strong>：如果 $\mathbb{E}[\int_0^t f_s^2 ds] < \infty$，则 $M_t = \int_0^t f_s dB_s$ 是鞅</li>
            </ul>
        </div>
        
        <h3>A.3.3 伊藤积分的计算示例</h3>
        
        <div class="exercise">
            <div class="exercise-title">例子：计算 $\int_0^t B_s \, dB_s$</div>
            <p>使用分部积分的思想，但要加上"伊藤修正项"。</p>
            <button class="answer-toggle" onclick="toggleAnswer('itoExample1')">显示推导</button>
            <div id="itoExample1" class="answer">
                <p>考虑 $f(x) = \frac{1}{2}x^2$，则 $f(B_t) = \frac{1}{2}B_t^2$。</p>
                <p>离散近似：</p>
                $$f(B_t) - f(B_0) = \sum_{i=0}^{n-1} [f(B_{t_{i+1}}) - f(B_{t_i})]$$
                <p>泰勒展开（保留到二阶）：</p>
                $$f(B_{t_{i+1}}) - f(B_{t_i}) \approx f'(B_{t_i})\Delta B_i + \frac{1}{2}f''(B_{t_i})(\Delta B_i)^2$$
                <p>其中 $\Delta B_i = B_{t_{i+1}} - B_{t_i}$。</p>
                <p>代入 $f'(x) = x$, $f''(x) = 1$：</p>
                $$\frac{1}{2}B_t^2 = \sum_{i=0}^{n-1} B_{t_i} \Delta B_i + \frac{1}{2}\sum_{i=0}^{n-1} (\Delta B_i)^2$$
                <p>当 $n \to \infty$：</p>
                <ul>
                    <li>第一项 → $\int_0^t B_s \, dB_s$</li>
                    <li>第二项 → $\frac{1}{2}t$（二次变差）</li>
                </ul>
                <p>因此：$\int_0^t B_s \, dB_s = \frac{1}{2}B_t^2 - \frac{1}{2}t$</p>
            </div>
        </div>
        
        <h3>A.3.4 伊藤公式：随机微积分的链式法则</h3>
        
        <p>伊藤公式是随机微积分最重要的工具，它告诉我们如何对复合函数求微分。与普通微积分的关键区别是多了一个二阶项。</p>
        
        <div class="definition">
            <div class="definition-title">定理 A.1（伊藤公式）</div>
            设 $X_t$ 满足 SDE：$dX_t = \mu(X_t, t)dt + \sigma(X_t, t)dB_t$，$f(x, t) \in C^{2,1}$，则：
            $$df(X_t, t) = \left[\frac{\partial f}{\partial t} + \mu \frac{\partial f}{\partial x} + \frac{1}{2}\sigma^2 \frac{\partial^2 f}{\partial x^2}\right]dt + \sigma \frac{\partial f}{\partial x} dB_t$$
        </div>
        
        <div class="visualization">
            <p><strong>伊藤公式的直观理解：</strong></p>
            <p>普通微积分：$df = f'(x)dx$（一阶泰勒展开）</p>
            <p>随机微积分：需要保留二阶项，因为 $(dB_t)^2 = dt$ 不是高阶无穷小！</p>
            <table style="margin: 20px auto; border-collapse: collapse;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 10px;">运算</th>
                    <th style="border: 1px solid #ddd; padding: 10px;">$dt \cdot dt$</th>
                    <th style="border: 1px solid #ddd; padding: 10px;">$dt \cdot dB_t$</th>
                    <th style="border: 1px solid #ddd; padding: 10px;">$dB_t \cdot dB_t$</th>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 10px;">结果</td>
                    <td style="border: 1px solid #ddd; padding: 10px;">0（高阶）</td>
                    <td style="border: 1px solid #ddd; padding: 10px;">0（高阶）</td>
                    <td style="border: 1px solid #ddd; padding: 10px; background-color: #ffe6e6;">$dt$（一阶！）</td>
                </tr>
            </table>
        </div>
        
        <h3>A.3.5 伊藤公式的推导思路</h3>
        
        <p>让我们通过一个启发式的推导理解伊藤公式为什么是这样：</p>
        
        <div class="math-block">
            $$f(X_{t+dt}, t+dt) - f(X_t, t) \approx \frac{\partial f}{\partial t}dt + \frac{\partial f}{\partial x}dX_t + \frac{1}{2}\frac{\partial^2 f}{\partial x^2}(dX_t)^2$$
        </div>
        
        <p>关键在于计算 $(dX_t)^2$：</p>
        <div class="math-block">
            $$(dX_t)^2 = (\mu dt + \sigma dB_t)^2 = \mu^2(dt)^2 + 2\mu\sigma dt \cdot dB_t + \sigma^2(dB_t)^2$$
        </div>
        
        <p>使用伊藤规则：</p>
        <ul>
            <li>$(dt)^2 = 0$（高阶无穷小）</li>
            <li>$dt \cdot dB_t = 0$（高阶无穷小）</li>
            <li>$(dB_t)^2 = dt$（关键！）</li>
        </ul>
        
        <p>因此 $(dX_t)^2 = \sigma^2 dt$，这就是伊藤修正项的来源。</p>
        
        <h3>A.3.6 伊藤公式的应用</h3>
        
        <div class="exercise">
            <div class="exercise-title">例子1：几何布朗运动</div>
            <p>设 $S_t$ 满足 $dS_t = \mu S_t dt + \sigma S_t dB_t$，求 $\log S_t$ 的动态。</p>
            <button class="answer-toggle" onclick="toggleAnswer('itoApp1')">显示解答</button>
            <div id="itoApp1" class="answer">
                <p>设 $f(x) = \log x$，则：</p>
                <ul>
                    <li>$\frac{\partial f}{\partial x} = \frac{1}{x}$</li>
                    <li>$\frac{\partial^2 f}{\partial x^2} = -\frac{1}{x^2}$</li>
                </ul>
                <p>应用伊藤公式：</p>
                $$d(\log S_t) = \left[0 + \mu S_t \cdot \frac{1}{S_t} + \frac{1}{2}\sigma^2 S_t^2 \cdot \left(-\frac{1}{S_t^2}\right)\right]dt + \sigma S_t \cdot \frac{1}{S_t} dB_t$$
                $$= \left(\mu - \frac{\sigma^2}{2}\right)dt + \sigma dB_t$$
                <p>积分得：$\log S_t = \log S_0 + \left(\mu - \frac{\sigma^2}{2}\right)t + \sigma B_t$</p>
                <p>因此：$S_t = S_0 \exp\left[\left(\mu - \frac{\sigma^2}{2}\right)t + \sigma B_t\right]$</p>
                <p><strong>注意</strong>：指数中出现了 $-\frac{\sigma^2}{2}$ 项，这是伊藤修正！</p>
            </div>
        </div>
        
        <div class="exercise">
            <div class="exercise-title">例子2：Ornstein-Uhlenbeck过程的平方</div>
            <p>设 $X_t$ 满足 $dX_t = -\theta X_t dt + \sigma dB_t$，求 $X_t^2$ 的SDE。</p>
            <button class="answer-toggle" onclick="toggleAnswer('itoApp2')">显示解答</button>
            <div id="itoApp2" class="answer">
                <p>设 $f(x) = x^2$，则 $f'(x) = 2x$，$f''(x) = 2$。</p>
                <p>应用伊藤公式：</p>
                $$d(X_t^2) = \left[-\theta X_t \cdot 2X_t + \frac{1}{2}\sigma^2 \cdot 2\right]dt + \sigma \cdot 2X_t dB_t$$
                $$= (-2\theta X_t^2 + \sigma^2)dt + 2\sigma X_t dB_t$$
                <p>这给出了 $X_t^2$ 的动态方程。注意漂移项中包含了 $\sigma^2$，这来自伊藤修正。</p>
            </div>
        </div>
        
        <h3>A.3.7 多维伊藤公式</h3>
        
        <p>对于多个布朗运动的情况，伊藤公式需要考虑所有的二阶交叉项：</p>
        
        <div class="definition">
            <div class="definition-title">定理 A.2（多维伊藤公式）</div>
            设 $X_t^i$ 满足 $dX_t^i = \mu^i dt + \sum_j \sigma^{ij} dB_t^j$，其中 $B_t^j$ 是独立的布朗运动。
            对于 $f(x^1, \ldots, x^n, t)$：
            $$df = \frac{\partial f}{\partial t}dt + \sum_i \frac{\partial f}{\partial x^i}dX_t^i + \frac{1}{2}\sum_{i,j} \frac{\partial^2 f}{\partial x^i \partial x^j}d\langle X^i, X^j \rangle_t$$
        </div>
        
        <p>其中二次共变差 $d\langle X^i, X^j \rangle_t = \sum_k \sigma^{ik}\sigma^{jk} dt$。</p>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.3：伊藤公式的综合应用</div>
            <p>1. 设 $B_t$ 是标准布朗运动，计算 $d(B_t^3)$。</p>
            <p>2. 证明 $e^{B_t - \frac{t}{2}}$ 是鞅。</p>
            <p>3. 设 $X_t = t B_t$，求 $dX_t$ 的表达式（提示：这是一个时变函数）。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA3new')">显示答案</button>
            <div id="answerA3new" class="answer">
                <p><strong>解答：</strong></p>
                <p>1. 对 $f(x) = x^3$：</p>
                <ul>
                    <li>$f'(x) = 3x^2$, $f''(x) = 6x$</li>
                    <li>$d(B_t^3) = [0 + 0 + \frac{1}{2} \cdot 1 \cdot 6B_t]dt + 3B_t^2 dB_t = 3B_t dt + 3B_t^2 dB_t$</li>
                </ul>
                <p>2. 设 $Y_t = e^{B_t - \frac{t}{2}}$，令 $f(x,t) = e^{x - \frac{t}{2}}$：</p>
                <ul>
                    <li>$\frac{\partial f}{\partial t} = -\frac{1}{2}e^{x - \frac{t}{2}}$</li>
                    <li>$\frac{\partial f}{\partial x} = e^{x - \frac{t}{2}}$</li>
                    <li>$\frac{\partial^2 f}{\partial x^2} = e^{x - \frac{t}{2}}$</li>
                </ul>
                <p>应用伊藤公式：</p>
                $$dY_t = \left[-\frac{1}{2} + 0 + \frac{1}{2}\right]Y_t dt + Y_t dB_t = Y_t dB_t$$
                <p>因此 $Y_t$ 是鞅（漂移项为0）。</p>
                <p>3. 对 $f(x,t) = tx$：</p>
                <ul>
                    <li>$\frac{\partial f}{\partial t} = x = B_t$</li>
                    <li>$\frac{\partial f}{\partial x} = t$</li>
                    <li>$\frac{\partial^2 f}{\partial x^2} = 0$</li>
                </ul>
                $$dX_t = d(tB_t) = B_t dt + t dB_t$$
                <p>这展示了乘积规则在随机情况下的形式。</p>
            </div>
        </div>
        
        <h2>A.4 随机微分方程</h2>
        
        <p>随机微分方程（SDE）描述了受随机扰动影响的动态系统。它们是扩散模型的数学基础，让我们能够精确描述前向和反向扩散过程。</p>
        
        <h3>A.4.1 什么是SDE？</h3>
        
        <p>一个典型的SDE具有形式：</p>
        <div class="math-block">
            $$dX_t = b(X_t, t)dt + \sigma(X_t, t)dB_t$$
        </div>
        
        <p>这可以理解为：</p>
        <ul>
            <li><strong>确定性部分</strong>：$b(X_t, t)dt$ — 漂移项，描述系统的平均行为</li>
            <li><strong>随机部分</strong>：$\sigma(X_t, t)dB_t$ — 扩散项，描述随机波动</li>
        </ul>
        
        <div class="visualization">
            <p><strong>物理类比：</strong></p>
            <p>想象一个在流动河水中的树叶：</p>
            <ul>
                <li>河水的流速 → 漂移项 $b(X_t, t)$</li>
                <li>水流的湍流扰动 → 扩散项 $\sigma(X_t, t)dB_t$</li>
                <li>树叶的轨迹 → 解 $X_t$</li>
            </ul>
        </div>
        
        <h3>A.4.2 SDE的积分形式</h3>
        
        <p>SDE实际上是积分方程的简写：</p>
        <div class="math-block">
            $$X_t = X_0 + \int_0^t b(X_s, s)ds + \int_0^t \sigma(X_s, s)dB_s$$
        </div>
        
        <p>第二个积分是伊藤积分，这使得求解SDE变得非平凡。</p>
        
        <h3>A.4.3 存在性与唯一性</h3>
        
        <div class="definition">
            <div class="definition-title">定理 A.3（存在唯一性定理）</div>
            考虑 SDE：$dX_t = b(X_t, t)dt + \sigma(X_t, t)dB_t$，$X_0 = x_0$。
            如果系数满足：
            <ol>
                <li><strong>Lipschitz 条件</strong>：存在常数 $K$ 使得
                    $$|b(x,t) - b(y,t)| + |\sigma(x,t) - \sigma(y,t)| \leq K|x-y|$$</li>
                <li><strong>线性增长条件</strong>：存在常数 $K$ 使得
                    $$|b(x,t)|^2 + |\sigma(x,t)|^2 \leq K^2(1 + |x|^2)$$</li>
            </ol>
            则 SDE 存在唯一的强解。
        </div>
        
        <div class="note">
            <strong>条件的直观理解：</strong>
            <ul>
                <li><strong>Lipschitz条件</strong>：系数不能变化太剧烈，保证了解的唯一性</li>
                <li><strong>线性增长条件</strong>：系数增长不能太快，保证了解不会在有限时间内爆炸</li>
            </ul>
        </div>
        
        <h3>A.4.4 经典SDE及其解</h3>
        
        <p>让我们深入研究几个在理论和应用中都非常重要的SDE：</p>
        
        <h4>1. Ornstein-Uhlenbeck (OU) 过程</h4>
        
        <div class="definition">
            <div class="definition-title">OU过程</div>
            $$dX_t = -\theta X_t dt + \sigma dB_t$$
            其中 $\theta > 0$ 是回归速度，$\sigma > 0$ 是波动率。
        </div>
        
        <p><strong>物理意义</strong>：描述带有恢复力的布朗粒子，$-\theta X_t$ 项将粒子拉回原点。</p>
        
        <div class="exercise">
            <div class="exercise-title">推导OU过程的解</div>
            <button class="answer-toggle" onclick="toggleAnswer('ouSolution')">显示推导</button>
            <div id="ouSolution" class="answer">
                <p>使用积分因子法。令 $Y_t = e^{\theta t} X_t$，应用伊藤公式：</p>
                $$dY_t = e^{\theta t} dX_t + \theta e^{\theta t} X_t dt$$
                $$= e^{\theta t}(-\theta X_t dt + \sigma dB_t) + \theta e^{\theta t} X_t dt$$
                $$= \sigma e^{\theta t} dB_t$$
                <p>积分得：$Y_t = Y_0 + \sigma \int_0^t e^{\theta s} dB_s$</p>
                <p>因此：</p>
                $$X_t = e^{-\theta t}X_0 + \sigma e^{-\theta t}\int_0^t e^{\theta s} dB_s$$
                $$= e^{-\theta t}X_0 + \sigma \int_0^t e^{-\theta(t-s)} dB_s$$
                <p><strong>性质</strong>：</p>
                <ul>
                    <li>$\mathbb{E}[X_t] = e^{-\theta t}X_0$ （指数衰减到0）</li>
                    <li>$\text{Var}(X_t) = \frac{\sigma^2}{2\theta}(1 - e^{-2\theta t})$ （收敛到 $\frac{\sigma^2}{2\theta}$）</li>
                    <li>稳态分布：$X_\infty \sim \mathcal{N}(0, \frac{\sigma^2}{2\theta})$</li>
                </ul>
            </div>
        </div>
        
        <h4>2. 几何布朗运动 (GBM)</h4>
        
        <div class="definition">
            <div class="definition-title">几何布朗运动</div>
            $$dS_t = \mu S_t dt + \sigma S_t dB_t$$
            其中 $\mu$ 是漂移率，$\sigma$ 是波动率。
        </div>
        
        <p><strong>应用</strong>：Black-Scholes模型中的股票价格模型。</p>
        
        <p><strong>解</strong>（使用伊藤公式对 $\log S_t$）：</p>
        <div class="math-block">
            $$S_t = S_0 \exp\left[\left(\mu - \frac{\sigma^2}{2}\right)t + \sigma B_t\right]$$
        </div>
        
        <div class="note">
            <strong>为什么有 $-\frac{\sigma^2}{2}$ 项？</strong>
            <p>这是伊藤修正！如果没有这一项，$\mathbb{E}[S_t] \neq S_0 e^{\mu t}$。正是这个修正保证了：</p>
            $$\mathbb{E}[S_t] = S_0 e^{\mu t}$$
        </div>
        
        <h4>3. Cox-Ingersoll-Ross (CIR) 过程</h4>
        
        <div class="definition">
            <div class="definition-title">CIR过程</div>
            $$dX_t = \kappa(\theta - X_t)dt + \sigma\sqrt{X_t}dB_t$$
            条件：$2\kappa\theta > \sigma^2$ 保证 $X_t > 0$。
        </div>
        
        <p><strong>特点</strong>：用于建模利率，保证非负性。扩散项 $\sigma\sqrt{X_t}$ 使得波动率随水平变化。</p>
        
        <h3>A.4.5 SDE的解法技巧</h3>
        
        <p>虽然大多数SDE没有解析解，但有几种常用的求解技巧：</p>
        
        <div class="note">
            <strong>常用技巧：</strong>
            <ol>
                <li><strong>积分因子法</strong>：适用于线性SDE</li>
                <li><strong>变量替换</strong>：通过伊藤公式简化方程</li>
                <li><strong>Feynman-Kac公式</strong>：将SDE与PDE联系起来</li>
                <li><strong>数值方法</strong>：Euler-Maruyama、Milstein等</li>
            </ol>
        </div>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.4：求解时变OU过程</div>
            <p>求解 $dX_t = -\theta(t) X_t dt + \sigma(t) dB_t$，其中 $\theta(t), \sigma(t)$ 是已知函数。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA4new')">显示答案</button>
            <div id="answerA4new" class="answer">
                <p>定义 $\Phi(t) = \exp\left(\int_0^t \theta(s)ds\right)$，令 $Y_t = \Phi(t)X_t$。</p>
                <p>应用伊藤公式：</p>
                $$dY_t = \Phi'(t)X_t dt + \Phi(t)dX_t = \sigma(t)\Phi(t)dB_t$$
                <p>积分得：</p>
                $$Y_t = Y_0 + \int_0^t \sigma(s)\Phi(s)dB_s$$
                <p>因此：</p>
                $$X_t = \frac{1}{\Phi(t)}\left[X_0 + \int_0^t \sigma(s)\Phi(s)dB_s\right]$$
                $$= e^{-\int_0^t \theta(s)ds}X_0 + \int_0^t \sigma(s)e^{-\int_s^t \theta(u)du}dB_s$$
            </div>
        </div>
        
        <h2>A.5 与扩散模型的深层联系</h2>
        
        <p>现在我们终于可以理解扩散模型的数学基础了。扩散模型的核心是两个相互关联的SDE：前向过程和反向过程。</p>
        
        <h3>A.5.1 前向扩散过程</h3>
        
        <p>扩散模型的前向过程是一个精心设计的SDE：</p>
        <div class="math-block">
            $$dx = f(x, t)dt + g(t)dB_t$$
        </div>
        
        <p>在DDPM中，选择 $f(x, t) = -\frac{1}{2}\beta(t)x$ 和 $g(t) = \sqrt{\beta(t)}$，得到：</p>
        <div class="math-block">
            $$dx = -\frac{1}{2}\beta(t)x dt + \sqrt{\beta(t)} dB_t$$
        </div>
        
        <div class="note">
            <strong>为什么这样选择？</strong>
            <ul>
                <li>线性漂移 $-\frac{1}{2}\beta(t)x$ 使得方程可解</li>
                <li>时变系数 $\beta(t)$ 控制扩散速度</li>
                <li>最终分布收敛到标准正态分布 $\mathcal{N}(0, I)$</li>
            </ul>
        </div>
        
        <div class="exercise">
            <div class="exercise-title">关键推导：前向过程的解</div>
            <p>证明前向SDE的解具有形式：$x_t = \sqrt{\bar{\alpha}_t} x_0 + \sqrt{1 - \bar{\alpha}_t} \epsilon$</p>
            <button class="answer-toggle" onclick="toggleAnswer('forwardSDE')">显示答案</button>
            <div id="forwardSDE" class="answer">
                <p>这是一个时变OU过程。定义 $\alpha_t = 1 - \beta_t$ 和 $\bar{\alpha}_t = \prod_{s=0}^t \alpha_s$（离散情况）或 $\bar{\alpha}_t = \exp\left(-\int_0^t \beta(s)ds\right)$（连续情况）。</p>
                <p>使用积分因子 $\Phi(t) = 1/\sqrt{\bar{\alpha}_t}$：</p>
                <ol>
                    <li>令 $y_t = x_t / \sqrt{\bar{\alpha}_t}$</li>
                    <li>应用伊藤公式得 $dy_t = \frac{\sqrt{\beta(t)}}{\sqrt{\bar{\alpha}_t}} dB_t$</li>
                    <li>积分：$y_t = y_0 + \int_0^t \frac{\sqrt{\beta(s)}}{\sqrt{\bar{\alpha}_s}} dB_s$</li>
                    <li>因此：$x_t = \sqrt{\bar{\alpha}_t} x_0 + \sqrt{\bar{\alpha}_t} \int_0^t \frac{\sqrt{\beta(s)}}{\sqrt{\bar{\alpha}_s}} dB_s$</li>
                </ol>
                <p>关键观察：积分 $\int_0^t \frac{\sqrt{\beta(s)}}{\sqrt{\bar{\alpha}_s}} dB_s$ 是均值为0的高斯随机变量，其方差为：</p>
                $$\text{Var} = \int_0^t \frac{\beta(s)}{\bar{\alpha}_s} ds = \frac{1 - \bar{\alpha}_t}{\bar{\alpha}_t}$$
                <p>因此 $x_t \sim \mathcal{N}(\sqrt{\bar{\alpha}_t} x_0, 1 - \bar{\alpha}_t)$，可以写成：</p>
                $$x_t = \sqrt{\bar{\alpha}_t} x_0 + \sqrt{1 - \bar{\alpha}_t} \epsilon, \quad \epsilon \sim \mathcal{N}(0, I)$$
            </div>
        </div>
        
        <h3>A.5.2 反向扩散过程</h3>
        
        <p>扩散模型的魔力在于反向过程。Anderson (1982) 证明了，如果前向过程是：</p>
        <div class="math-block">
            $$dx = f(x, t)dt + g(t)dB_t$$
        </div>
        
        <p>那么时间反演的过程（从 $t=T$ 到 $t=0$）满足：</p>
        <div class="math-block">
            $$dx = [f(x, t) - g(t)^2 \nabla_x \log p_t(x)]dt + g(t)d\bar{B}_t$$
        </div>
        
        <p>其中 $\bar{B}_t$ 是反向时间的布朗运动，$p_t(x)$ 是 $x_t$ 的概率密度。</p>
        
        <div class="note">
            <strong>Score function 的出现！</strong>
            <p>$\nabla_x \log p_t(x)$ 称为 score function，它指向概率密度增加最快的方向。学习这个函数是扩散模型的核心任务。</p>
        </div>
        
        <h2>A.6 鞅论基础</h2>
        
        <h3>A.6.1 鞅的定义与性质</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.5（鞅）</div>
            随机过程 $\{M_t\}_{t \geq 0}$ 称为关于滤波 $\{\mathcal{F}_t\}$ 的鞅，如果：
            <ol>
                <li>$M_t$ 是 $\mathcal{F}_t$-可测的</li>
                <li>$\mathbb{E}[|M_t|] < \infty$ 对所有 $t \geq 0$</li>
                <li>$\mathbb{E}[M_t | \mathcal{F}_s] = M_s$ 对所有 $0 \leq s \leq t$</li>
            </ol>
        </div>
        
        <p>鞅是"公平游戏"的数学化：给定过去的信息，未来的期望值等于现在的值。</p>
        
        <div class="note">
            <strong>重要例子：</strong>
            <ul>
                <li>布朗运动 $B_t$ 是鞅</li>
                <li>$B_t^2 - t$ 是鞅（补偿布朗运动）</li>
                <li>$\exp(\sigma B_t - \frac{\sigma^2 t}{2})$ 是鞅（指数鞅）</li>
            </ul>
        </div>
        
        <h3>A.6.2 鞅表示定理</h3>
        
        <div class="definition">
            <div class="definition-title">定理 A.3（鞅表示定理）</div>
            设 $M_t$ 是关于布朗运动 $B_t$ 生成的滤波的平方可积鞅。则存在适应过程 $\phi_t$ 使得：
            $$M_t = M_0 + \int_0^t \phi_s dB_s$$
        </div>
        
        <p>这个定理告诉我们，所有的鞅都可以表示为关于布朗运动的随机积分，这在金融数学和扩散模型理论中非常重要。</p>
        
        <h3>A.6.3 Doob-Meyer 分解</h3>
        
        <p>任何连续半鞅 $X_t$ 都可以唯一分解为：</p>
        <div class="math-block">
            $$X_t = X_0 + M_t + A_t$$
        </div>
        <p>其中 $M_t$ 是局部鞅，$A_t$ 是有界变差过程。</p>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.4：验证鞅性质</div>
            <p>证明过程 $M_t = \int_0^t s dB_s$ 是鞅，并计算其二次变差 $\langle M \rangle_t$。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA4')">显示答案</button>
            <div id="answerA4" class="answer">
                <p><strong>解答：</strong></p>
                <p>1. 验证鞅性质：对 $s < t$，</p>
                $$\mathbb{E}[M_t | \mathcal{F}_s] = \mathbb{E}\left[\int_0^t u dB_u \bigg| \mathcal{F}_s\right]$$
                $$= \int_0^s u dB_u + \mathbb{E}\left[\int_s^t u dB_u \bigg| \mathcal{F}_s\right]$$
                $$= M_s + 0 = M_s$$
                <p>2. 计算二次变差：</p>
                $$\langle M \rangle_t = \int_0^t s^2 ds = \frac{t^3}{3}$$
            </div>
        </div>
        
        <h2>A.7 Girsanov 定理与测度变换</h2>
        
        <h3>A.7.1 Radon-Nikodym 导数</h3>
        
        <div class="definition">
            <div class="definition-title">定义 A.6（Radon-Nikodym 导数）</div>
            设 $\mathbb{P}$ 和 $\mathbb{Q}$ 是概率测度，如果 $\mathbb{Q} \ll \mathbb{P}$（$\mathbb{Q}$ 关于 $\mathbb{P}$ 绝对连续），则存在 $\mathcal{F}$-可测的非负随机变量 $Z$，使得：
            $$\mathbb{Q}(A) = \mathbb{E}^{\mathbb{P}}[Z \mathbf{1}_A]$$
            $Z$ 称为 Radon-Nikodym 导数，记为 $\frac{d\mathbb{Q}}{d\mathbb{P}}$。
        </div>
        
        <h3>A.7.2 Girsanov 定理</h3>
        
        <div class="definition">
            <div class="definition-title">定理 A.4（Girsanov 定理）</div>
            设 $\theta_t$ 是适应过程，满足 Novikov 条件。定义：
            $$Z_t = \exp\left(-\int_0^t \theta_s dB_s - \frac{1}{2}\int_0^t \theta_s^2 ds\right)$$
            在新测度 $\mathbb{Q}$ 下（$\frac{d\mathbb{Q}}{d\mathbb{P}}\big|_{\mathcal{F}_t} = Z_t$），过程：
            $$\tilde{B}_t = B_t + \int_0^t \theta_s ds$$
            是标准布朗运动。
        </div>
        
        <p>Girsanov 定理允许我们改变概率测度，从而改变漂移项。这在扩散模型的理论分析中非常重要。</p>
        
        <h2>A.8 Fokker-Planck 方程与 Kolmogorov 方程</h2>
        
        <h3>A.8.1 Fokker-Planck 方程</h3>
        
        <p>对于 SDE $dX_t = b(X_t, t)dt + \sigma(X_t, t)dB_t$，其概率密度 $p(x, t)$ 满足 Fokker-Planck 方程（也称为前向 Kolmogorov 方程）：</p>
        
        <div class="math-block">
            $$\frac{\partial p}{\partial t} = -\nabla \cdot (b p) + \frac{1}{2}\nabla^2 : (\sigma \sigma^T p)$$
        </div>
        
        <p>在一维情况下：</p>
        <div class="math-block">
            $$\frac{\partial p}{\partial t} = -\frac{\partial}{\partial x}(b(x,t) p) + \frac{1}{2}\frac{\partial^2}{\partial x^2}(\sigma^2(x,t) p)$$
        </div>
        
        <h3>A.8.2 后向 Kolmogorov 方程</h3>
        
        <p>对于函数 $u(x, t) = \mathbb{E}[f(X_T) | X_t = x]$，它满足后向 Kolmogorov 方程：</p>
        
        <div class="math-block">
            $$\frac{\partial u}{\partial t} + b(x,t)\frac{\partial u}{\partial x} + \frac{1}{2}\sigma^2(x,t)\frac{\partial^2 u}{\partial x^2} = 0$$
        </div>
        
        <p>边界条件：$u(x, T) = f(x)$。</p>
        
        <div class="exercise">
            <div class="exercise-title">练习 A.5：Ornstein-Uhlenbeck 过程的稳态分布</div>
            <p>使用 Fokker-Planck 方程求解 OU 过程 $dX_t = -\theta X_t dt + \sigma dB_t$ 的稳态分布。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA5')">显示答案</button>
            <div id="answerA5" class="answer">
                <p><strong>解答：</strong></p>
                <p>稳态时 $\frac{\partial p}{\partial t} = 0$，Fokker-Planck 方程变为：</p>
                $$0 = \frac{\partial}{\partial x}(\theta x p) + \frac{\sigma^2}{2}\frac{\partial^2 p}{\partial x^2}$$
                <p>令概率流 $J = -\theta x p - \frac{\sigma^2}{2}\frac{\partial p}{\partial x} = 0$（稳态无净流）</p>
                <p>解得：$p(x) \propto \exp\left(-\frac{\theta x^2}{\sigma^2}\right)$</p>
                <p>归一化后得到稳态分布：$p(x) = \sqrt{\frac{\theta}{\pi \sigma^2}} \exp\left(-\frac{\theta x^2}{\sigma^2}\right)$</p>
                <p>即 $X_\infty \sim \mathcal{N}\left(0, \frac{\sigma^2}{2\theta}\right)$。</p>
            </div>
        </div>
        
        <h2>A.9 随机分析的高级主题</h2>
        
        <h3>A.9.1 局部时与 Tanaka 公式</h3>
        
        <p>布朗运动在 0 点的局部时 $L_t^0$ 测量布朗运动在 0 附近花费的时间：</p>
        <div class="math-block">
            $$L_t^0 = \lim_{\epsilon \to 0} \frac{1}{2\epsilon} \int_0^t \mathbf{1}_{|B_s| < \epsilon} ds$$
        </div>
        
        <div class="definition">
            <div class="definition-title">定理 A.5（Tanaka 公式）</div>
            对于布朗运动 $B_t$：
            $$|B_t| = \int_0^t \text{sgn}(B_s) dB_s + L_t^0$$
        </div>
        
        <h3>A.9.2 反射布朗运动</h3>
        
        <p>反射布朗运动 $|B_t|$ 在 0 处被反射。它的生成元是：</p>
        <div class="math-block">
            $$\mathcal{L} = \frac{1}{2}\frac{d^2}{dx^2}, \quad x > 0$$
        </div>
        <p>边界条件：$\frac{\partial u}{\partial x}(0) = 0$（Neumann 边界条件）。</p>
        
        <h3>A.9.3 Bessel 过程</h3>
        
        <p>$n$ 维 Bessel 过程定义为 $n$ 维布朗运动的范数：$R_t = |B_t^{(n)}|$。它满足：</p>
        <div class="math-block">
            $$dR_t = \frac{n-1}{2R_t}dt + dW_t$$
        </div>
        <p>其中 $W_t$ 是一维布朗运动。</p>
        
        <h2>A.10 数值方法</h2>
        
        <h3>A.10.1 Euler-Maruyama 方法</h3>
        
        <p>对于 SDE $dX_t = b(X_t)dt + \sigma(X_t)dB_t$，Euler-Maruyama 离散化为：</p>
        <div class="math-block">
            $$X_{n+1} = X_n + b(X_n)\Delta t + \sigma(X_n)\sqrt{\Delta t} Z_n$$
        </div>
        <p>其中 $Z_n \sim \mathcal{N}(0, 1)$ 独立同分布。</p>
        
        <h3>A.10.2 Milstein 方法</h3>
        
        <p>更高阶的 Milstein 方法包含伊藤修正项：</p>
        <div class="math-block">
            $$X_{n+1} = X_n + b(X_n)\Delta t + \sigma(X_n)\sqrt{\Delta t} Z_n + \frac{1}{2}\sigma(X_n)\sigma'(X_n)\Delta t(Z_n^2 - 1)$$
        </div>
        
        <div class="code-collapsible">
            <button class="code-toggle collapsed" onclick="toggleCode('sdeNumericalCode')">
                <span>Python代码：SDE数值方法比较</span>
            </button>
            <div id="sdeNumericalCode" class="code-content collapsed">
                <pre><code class="language-python">import numpy as np
import matplotlib.pyplot as plt

def euler_maruyama(x0, drift, diffusion, T, N):
    """Euler-Maruyama方法"""
    dt = T / N
    X = np.zeros(N + 1)
    X[0] = x0
    
    for i in range(N):
        dW = np.sqrt(dt) * np.random.randn()
        X[i+1] = X[i] + drift(X[i]) * dt + diffusion(X[i]) * dW
    
    return X

def milstein(x0, drift, diffusion, diffusion_prime, T, N):
    """Milstein方法"""
    dt = T / N
    X = np.zeros(N + 1)
    X[0] = x0
    
    for i in range(N):
        Z = np.random.randn()
        dW = np.sqrt(dt) * Z
        X[i+1] = X[i] + drift(X[i]) * dt + diffusion(X[i]) * dW + \
                 0.5 * diffusion(X[i]) * diffusion_prime(X[i]) * dt * (Z**2 - 1)
    
    return X

# 测试：几何布朗运动
# dX_t = μX_t dt + σX_t dB_t
μ, σ = 0.1, 0.3
drift = lambda x: μ * x
diffusion = lambda x: σ * x
diffusion_prime = lambda x: σ

# 解析解
def analytical_solution(x0, t, W):
    return x0 * np.exp((μ - 0.5 * σ**2) * t + σ * W)

# 模拟参数
x0, T, N = 1.0, 1.0, 1000
t = np.linspace(0, T, N + 1)

# 多次模拟比较误差
n_simulations = 100
euler_errors = []
milstein_errors = []

for _ in range(n_simulations):
    # 生成布朗运动路径
    dW = np.sqrt(T/N) * np.random.randn(N)
    W = np.concatenate([[0], np.cumsum(dW)])
    
    # 真实解
    X_true = analytical_solution(x0, t, W)
    
    # Euler-Maruyama
    X_euler = euler_maruyama(x0, drift, diffusion, T, N)
    euler_errors.append(np.abs(X_euler[-1] - X_true[-1]))
    
    # Milstein
    X_milstein = milstein(x0, drift, diffusion, diffusion_prime, T, N)
    milstein_errors.append(np.abs(X_milstein[-1] - X_true[-1]))

print(f"Euler-Maruyama 平均误差: {np.mean(euler_errors):.6f}")
print(f"Milstein 平均误差: {np.mean(milstein_errors):.6f}")

# 绘制一条样本路径
plt.figure(figsize=(10, 6))
plt.plot(t, X_true, 'k-', label='解析解', linewidth=2)
plt.plot(t, X_euler, 'b--', label='Euler-Maruyama', alpha=0.7)
plt.plot(t, X_milstein, 'r:', label='Milstein', alpha=0.7)
plt.xlabel('时间 t')
plt.ylabel('X(t)')
plt.title('SDE数值方法比较')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()</code></pre>
            </div>
        </div>
        
        <h2>A.11 与扩散模型的深层联系</h2>
        
        <h3>A.11.1 Score函数与漂移项</h3>
        
        <p>在扩散模型中，反向SDE的漂移项包含score函数 $\nabla_x \log p_t(x)$：</p>
        <div class="math-block">
            $$dx = \left[f(x, t) - g^2(t)\nabla_x \log p_t(x)\right]dt + g(t)d\bar{B}_t$$
        </div>
        
        <p>这里的score函数满足：</p>
        <div class="math-block">
            $$\nabla_x \log p_t(x) = -\frac{1}{\sqrt{1-\bar{\alpha}_t}}\mathbb{E}[\epsilon | x_t = x]$$
        </div>
        
        <h3>A.11.2 时间反演与伴随过程</h3>
        
        <p>对于前向SDE，其时间反演过程（从 $t=T$ 到 $t=0$）由Anderson定理给出。这正是扩散模型反向过程的理论基础。</p>
        
        <div class="exercise">
            <div class="exercise-title">综合练习：推导扩散模型的反向SDE</div>
            <p>从前向SDE $dx = -\frac{1}{2}\beta(t)x dt + \sqrt{\beta(t)} dB_t$ 出发，使用时间反演理论推导反向SDE。</p>
            <button class="answer-toggle" onclick="toggleAnswer('answerA_final')">显示答案</button>
            <div id="answerA_final" class="answer">
                <p><strong>提示：</strong></p>
                <ol>
                    <li>写出前向过程的Fokker-Planck方程</li>
                    <li>使用Anderson定理，反向漂移项为：$b_{rev} = -b_{for} + \sigma^2 \nabla \log p_t$</li>
                    <li>计算score函数 $\nabla \log p_t(x)$</li>
                    <li>代入得到反向SDE</li>
                </ol>
                <p>关键洞察：score函数编码了数据分布的信息，学习score函数等价于学习如何去噪。</p>
            </div>
        </div>
        
        <h2>A.12 进一步学习资源</h2>
        
        <div class="note">
            <strong>推荐阅读：</strong>
            <ul>
                <li>Øksendal, B. "Stochastic Differential Equations" - SDE 的经典教材</li>
                <li>Karatzas, I. & Shreve, S. "Brownian Motion and Stochastic Calculus" - 更深入的理论</li>
                <li>Evans, L.C. "An Introduction to Stochastic Differential Equations" - 适合初学者</li>
            </ul>
        </div>
        
        <div class="chapter-summary">
            <h2>本章小结</h2>
            <p>在本附录中，我们快速回顾了理解连续时间扩散模型所需的数学基础：</p>
            <ul>
                <li>测度论提供了处理连续随机变量的严格框架</li>
                <li>布朗运动是扩散过程的基本构建块</li>
                <li>伊藤公式是随机微积分的链式法则，包含额外的二阶项</li>
                <li>SDE 描述了随机系统的演化，扩散模型的前向过程就是一个 SDE</li>
            </ul>
            <p>这些工具将在第5章中用于理解扩散模型的连续时间公式化，特别是 Score-based SDE 框架。</p>
        </div>
    </div>
</body>
</html>